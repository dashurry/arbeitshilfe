<template>
    <div>
        <vue-dropzone :options="this.dropzoneOptions" v-on:vdropzone-file-added="addedFile" 
        :id="this.id" :useCustomSlot=true :ref="this.img_ref" v-on:vdropzone-error="failed"
        v-on:vdropzone-queue-complete="successUpload">
            <div class="form-group form-group-label">
                <div class="wt-labelgroup p-3">
                    <label for="file">
                        <span class="btn" v-if="btn_text">{{ btn_text }}</span>
                        <span class="btn btn-lg btn-success lift mb-3" v-else>{{ trans('lang.select_files') }}</span>
                    </label>
                    <span v-if="drop_text">{{ drop_text }}</span>
                    <span v-else>{{ trans('lang.drop_files') }}</span>
                </div>
            </div>
        </vue-dropzone> 
        <div :class="this.id" v-if="this.dropzoneOptions.maxFiles == 1"></div>
    </div>
</template>
<style scoped>
@import '~vue2-dropzone/dist/vue2Dropzone.min.css';
</style>
<script>
// const getImageUploadTemplate = () => `
//     <div class="wt-uploadingbox">
//     <div class="dz-preview dz-file-preview">
//         <figure><img data-dz-thumbnail /></figure>
//         <div class="wt-uploadingbar">
//         <div class="dz-filename"><span data-dz-name></span></div>
//         <em><div class="dz-size" data-dz-size></div><a class="lnr lnr-cross" href="javascript:;" data-dz-remove=""></a>
//         <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div>
//         <div class="dz-success-mark"><i class="fa fa-check"></i></div>
//         </em>
//         </div>
//     </div>
//     </div>
// `;
import vue2Dropzone from 'vue2-dropzone'
export default {
    props: ['id', 'img_ref', 'url', 'name', 'max_images', 'hidden_name', 'hidden_id', 'dynamicHidden', 'drop_text', 'btn_text'],    
    components: {
        vueDropzone: vue2Dropzone
    },
    data: function () {
        return {
        is_show:true,
        options: {
            error: {
                position: 'center',
                timeout: 3000,
            },
        },
        dropzoneOptions: {
                url: this.getUrl(),
                maxFilesize: 2, // MB
                maxFiles: this.getMaxImages(),
                previewTemplate: this.getImageUploadTemplate(),
                previewsContainer: '.'+this.getPreviewerClass(),
                paramName:this.getName(),
                renameFile: function (file) {
                    var newName = Math.floor(1000 + Math.random() * 9000) + '-' + file.name;
                    // let newName = new Date().getTime() + '_' + file.name;
                    return file.renameFilename = newName
                },
                acceptedFiles:'image/*',
                headers: {
                    'x-csrf-token': document.querySelectorAll('meta[name=csrf-token]')[0].getAttributeNode('content').value,
                },
                init: function() {
                    var myDropzone = this;
                    this.on("addedfile", function(file) { 
                        var input_hidden_id = jQuery('#'+myDropzone.element.id).parents('.wt-settingscontent').find('.wt-userform input[type=hidden]').attr('id');
                        console.log(input_hidden_id);
                        document.getElementById(input_hidden_id).value = file.name;     
                    });
                    this.on("removedfile", function(file) { 
                        if (jQuery('#'+myDropzone.element.id).parents('.wt-settingscontent').find('.wt-userform input[type=hidden]')) {
                            var input_hidden_id = jQuery('#'+myDropzone.element.id).parents('.wt-settingscontent').find('.wt-userform input[type=hidden]').attr('id');
                            if (document.getElementById(input_hidden_id) && document.getElementById(input_hidden_id).value) {
                                document.getElementById(input_hidden_id).value = ''; 
                            }
                        }
                    });
                }
            },
        }
    },
    methods:{
        getImageUploadTemplate() {
            return `
                    <div class="card">
                            <img data-dz-thumbnail />
                            <div class="card-body">
                                <h6 class="card-title" data-dz-name></h6>
                                <div class="d-flex">
                                    <p class="card-text" data-dz-size></p>
                                    <a href="javascript:;" class="material-symbols-outlined text-decoration-none text-danger" data-dz-remove="">close</a>
                                </div>
                                <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div>
                                <div class="dz-success-mark"><i class="fa fa-check"></i></div>
                                </em>
                            </div>
                    </div>
                `;
        },
        showError(message){
            return this.$toast.error(' ', message, this.options.error);
        },
        getUrl() {
            return this.url;
        },
        getMaxImages() {
            if (this.max_images) {
                return this.max_images
            } else {
                return 1
            }
        },
        successUpload: function () {
            this.$emit('addedSuccess', 'file-add')  
        },
        getName() {
            return this.name;
        },
        getPreviewerClass() {
            return this.id;
        },
        addedFile: function(file) {
            // console.log(file)
            if (this.max_images > 1) {
                let parentClass = this.$refs[this.img_ref].id;
                parent = document.getElementsByClassName(this.id)
                // var listitems= parent[0].getElementsByTagName("li")
                var listitems= parent[0].getElementsByClassName("wt-uploadingbox")
                var i;
                for (i=0; i<listitems.length; i++) {
                    if (!(listitems[i].id)) {
                        listitems[i].setAttribute("id", parentClass+"-"+i);
                        var input = document.createElement("input");
                        input.setAttribute("type", "hidden");
                        input.setAttribute("name", this.hidden_name+'['+i+']'); 
                        input.setAttribute("value", file.renameFilename);
                        input.setAttribute("id", parentClass+'-attachment-'+i);
                    }
                }
                if (document.getElementById(file.previewElement.id)) {
                    var listParent = document.getElementById(file.previewElement.id)
                    listParent.appendChild(input);
                }
                this.$emit("addedFile", 'file-add');
            } else {
                if (this.dynamicHidden == 'true') {
                        let parentClass = this.$refs[this.img_ref].id;
                        parent = document.getElementsByClassName(this.id)
                        var listitems= parent[0].getElementsByClassName("wt-uploadingbox")
                        listitems[0].setAttribute("id", parentClass+"-"+this.id);
                        var input = document.createElement("input");
                        input.setAttribute("type", "hidden");
                        input.setAttribute("name", this.hidden_name); 
                        input.setAttribute("value", file.renameFilename);
                        input.setAttribute("id", this.hidden_id);
                        if (document.getElementById(file.previewElement.id)) {
                            var listParent = document.getElementById(file.previewElement.id)
                            listParent.appendChild(input);
                        }
                } else {
                    var input_hidden_id = jQuery('#'+this.$refs[this.img_ref].id).parents('.wt-settingscontent').find('.wt-userform input[type=hidden]').attr('id');
                    document.getElementById(input_hidden_id).value = file.renameFilename;  
                }
                this.$emit("addedFile", 'file-add');
            }
        },
        failed:function(file,message,xhr){
            if (file.type != this.$refs[this.img_ref].options.acceptedFiles) {
                if (message == 'You can not upload any more files.') {
                    message = 'you need to remove file before uploading new one.'
                }
                this.showError(message);
                this.$refs[this.img_ref].removeFile(file);
                var input_hidden_id = jQuery('#'+this.$refs[this.img_ref].id).parents('.wt-settingscontent').find('.wt-userform input[type=hidden]').attr('id');
                document.getElementById(input_hidden_id).value = '';     
            } 
        }
    },
}
</script>